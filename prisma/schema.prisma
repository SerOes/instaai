// This is your Prisma schema file for the AI-powered Instagram Content Tool
// Based on the specification: insta_ai_tool_extended_spec.md
// SQLite for development (no enums), PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?
  name          String?
  image         String?
  locale        String    @default("de") // "de", "en", "tr"
  systemPrompt  String? // Global business/brand context for AI
  
  // Role management
  role          String    @default("USER") // "ADMIN" | "USER"
  isActive      Boolean   @default(true)
  invitedBy     String?   // User ID of who invited this user
  invitedAt     DateTime? // When the invitation was sent
  
  // Onboarding data
  brandName     String?
  industry      String?
  targetAudience String?
  brandStyle    String    @default("[]") // JSON array as string for SQLite
  contentGoals  String    @default("[]") // JSON array as string for SQLite
  
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts          Account[]
  sessions          Session[]
  apiKeys           ApiKey[]
  instagramAccounts InstagramAccount[]
  mediaProjects     MediaProject[]
  aiPresets         AiPreset[]
  seasonalIdeas     SeasonalIdea[]
  
  // Password reset
  passwordResets    PasswordReset[]
}

// ==================== INVITATIONS ====================

model Invitation {
  id          String   @id @default(cuid())
  email       String   @unique
  token       String   @unique
  invitedById String   // Admin user ID who sent the invite
  name        String?  // Optional name for the invited user
  
  // Status tracking
  status      String   @default("PENDING") // "PENDING" | "ACCEPTED" | "EXPIRED" | "CANCELLED"
  expiresAt   DateTime
  acceptedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([token])
  @@index([invitedById])
}

// ==================== PASSWORD RESET ====================

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== API KEYS ====================

model ApiKey {
  id           String   @id @default(cuid())
  userId       String
  provider     String   // "GEMINI", "KIEAI", etc.
  keyEncrypted String
  label        String?  // Optional label for the key
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, provider])
}

// ==================== INSTAGRAM INTEGRATION ====================

model InstagramAccount {
  id                   String   @id @default(cuid())
  userId               String
  igBusinessId         String   @unique
  accessTokenEncrypted String
  username             String
  profileName          String?
  profilePicture       String?
  followersCount       Int?
  followingCount       Int?
  mediaCount           Int?
  lastSynced           DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  postSchedules     PostSchedule[]
  analyticsRecords  AnalyticsRecord[]
  dmConversations   DMConversation[]
  dmAutomation      DMAutomation?

  @@index([userId])
}

// ==================== MEDIA PROJECTS ====================
// Note: SQLite doesn't support enums, so we use String with validation in code
// type: "IMAGE" | "VIDEO"
// status: "DRAFT" | "SCHEDULED" | "PUBLISHED" | "FAILED"
// source: "GENERATED" | "UPLOADED" | "EDITED"

model MediaProject {
  id           String   @id @default(cuid())
  userId       String
  type         String   @default("IMAGE") // "IMAGE" or "VIDEO"
  title        String
  description  String?
  status       String   @default("DRAFT") // "DRAFT", "SCHEDULED", "PUBLISHED", "FAILED"
  source       String   @default("GENERATED") // "GENERATED", "UPLOADED", "EDITED"
  
  // File storage
  fileUrl      String?
  thumbnailUrl String?
  
  // AI Generation metadata
  prompt       String?
  style        String?
  aspectRatio  String?       // "1:1", "4:5", "9:16", "16:9"
  model        String?       // AI model used
  provider     String?       // AI provider used
  presetId     String?       // Reference to AI preset
  
  // Video-specific metadata
  videoDuration    Int?      // Duration in seconds
  videoResolution  String?   // "720p" | "1080p"
  videoProvider    String?   // "kieai" | "gemini-direct" for video generation
  
  // Additional metadata as JSON string for SQLite
  metadata     String?
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  captions     Caption[]
  postSchedules PostSchedule[]
  preset       AiPreset?     @relation(fields: [presetId], references: [id])

  @@index([userId, status])
  @@index([userId, type])
}

// ==================== CAPTIONS & HASHTAGS ====================

model Caption {
  id         String   @id @default(cuid())
  projectId  String
  language   String   @default("de") // "de", "en", "tr"
  text       String
  hashtags   String   @default("[]") // JSON array as string for SQLite
  tone       String?  // "informative", "emotional", "funny", etc.
  isSelected Boolean  @default(false)
  version    Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project MediaProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, language])
}

// ==================== POST SCHEDULING ====================
// status: "PENDING" | "PROCESSING" | "POSTED" | "FAILED" | "CANCELLED"
// postType: "FEED" | "REEL" | "STORY" | "CAROUSEL"

model PostSchedule {
  id                 String   @id @default(cuid())
  projectId          String
  instagramAccountId String
  scheduledAt        DateTime
  status             String   @default("PENDING") // "PENDING", "PROCESSING", "POSTED", "FAILED", "CANCELLED"
  postType           String   @default("FEED") // "FEED", "REEL", "STORY", "CAROUSEL"
  
  // Instagram post result
  igPostId           String?
  igPermalink        String?
  
  // Error tracking
  errorMessage       String?
  retryCount         Int      @default(0)
  lastAttemptAt      DateTime?
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  project           MediaProject     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  instagramAccount  InstagramAccount @relation(fields: [instagramAccountId], references: [id], onDelete: Cascade)

  @@index([scheduledAt, status])
  @@index([instagramAccountId])
}

// ==================== ANALYTICS ====================

model AnalyticsRecord {
  id                 String   @id @default(cuid())
  instagramAccountId String
  igPostId           String
  projectId          String?
  
  // Metrics
  likes              Int      @default(0)
  comments           Int      @default(0)
  saves              Int      @default(0)
  shares             Int      @default(0)
  reach              Int      @default(0)
  impressions        Int      @default(0)
  engagement         Float?   // Calculated engagement rate
  
  capturedAt         DateTime @default(now())

  instagramAccount InstagramAccount @relation(fields: [instagramAccountId], references: [id], onDelete: Cascade)

  @@unique([igPostId, capturedAt])
  @@index([instagramAccountId, capturedAt])
}

// ==================== AI PRESETS ====================
// type: "IMAGE" | "VIDEO"

model AiPreset {
  id             String   @id @default(cuid())
  userId         String?  // null = system preset
  name           String
  description    String?
  type           String   @default("IMAGE") // "IMAGE" or "VIDEO"
  category       String   // "product", "lifestyle", "story", etc.
  
  // Preset configuration
  promptTemplate String
  style          String?
  aspectRatio    String?
  duration       Int?     // For video presets (seconds)
  
  // Brand preset elements - JSON strings for SQLite
  colorPalette   String   @default("[]") // JSON array of hex colors
  fontFamily     String?
  logoPosition   String?  // "top-left", "bottom-right", etc.
  
  // Metadata
  isPublic       Boolean  @default(false)
  usageCount     Int      @default(0)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  mediaProjects  MediaProject[]

  @@index([userId, type])
  @@index([category, isPublic])
}

// ==================== DIRECT MESSAGES (DM) ====================
// direction: "INBOUND" | "OUTBOUND"
// status: "RECEIVED" | "READ" | "REPLIED" | "PENDING_REPLY"
// aiStatus: "PENDING" | "GENERATED" | "APPROVED" | "SENT" | "SKIPPED"

model DMConversation {
  id                  String   @id @default(cuid())
  instagramAccountId  String
  igConversationId    String   @unique // Instagram's conversation ID
  participantIgId     String   // The other participant's Instagram ID
  participantUsername String?
  participantName     String?
  participantPicture  String?
  
  // Conversation status
  isActive            Boolean  @default(true)
  isAutomated         Boolean  @default(false) // Whether AI automation is enabled
  lastMessageAt       DateTime?
  unreadCount         Int      @default(0)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  instagramAccount    InstagramAccount @relation(fields: [instagramAccountId], references: [id], onDelete: Cascade)
  messages            DirectMessage[]

  @@index([instagramAccountId, lastMessageAt])
  @@index([participantIgId])
}

model DirectMessage {
  id               String   @id @default(cuid())
  conversationId   String
  igMessageId      String?  @unique // Instagram's message ID
  
  // Message content
  direction        String   // "INBOUND" or "OUTBOUND"
  messageType      String   @default("TEXT") // "TEXT", "IMAGE", "VIDEO", "STORY_REPLY", "REEL_SHARE"
  content          String   // The actual message text
  mediaUrl         String?  // For image/video messages
  
  // Status tracking
  status           String   @default("RECEIVED") // "RECEIVED", "READ", "REPLIED", "PENDING_REPLY"
  
  // AI-generated response fields
  aiStatus         String?  // "PENDING", "GENERATED", "APPROVED", "SENT", "SKIPPED"
  aiResponse       String?  // AI-generated reply suggestion
  aiConfidence     Float?   // AI's confidence in the response (0-1)
  aiModel          String?  // Model used for generation
  
  // Timestamps
  sentAt           DateTime @default(now())
  readAt           DateTime?
  repliedAt        DateTime?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  conversation     DMConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, sentAt])
  @@index([direction, aiStatus])
}

model DMAutomation {
  id                  String   @id @default(cuid())
  instagramAccountId  String   @unique
  
  // Automation settings
  isEnabled           Boolean  @default(false)
  autoReplyEnabled    Boolean  @default(false) // Auto-send without approval
  
  // Response behavior
  defaultLanguage     String   @default("de") // "de", "en", "tr"
  tone                String   @default("friendly") // "friendly", "professional", "casual"
  responseDelay       Int      @default(0) // Seconds to wait before responding (for natural feel)
  
  // AI configuration
  systemPrompt        String?  // Custom system prompt for DM responses
  contextWindow       Int      @default(5) // Number of previous messages to include for context
  maxResponseLength   Int      @default(500)
  
  // Category-specific responses (JSON string for SQLite)
  categoryResponses   String   @default("{}") // e.g., {"faq": "...", "pricing": "...", "greeting": "..."}
  
  // Quick replies (JSON string for SQLite)
  quickReplies        String   @default("[]") // Predefined quick reply templates
  
  // Keywords and triggers (JSON string for SQLite)
  keywords            String   @default("{}") // Keywords mapped to specific responses
  
  // Blacklist/whitelist (JSON string for SQLite)
  blacklistedPhrases  String   @default("[]") // Phrases that trigger manual review
  
  // Operating hours (JSON string for SQLite)
  operatingHours      String   @default("{}") // e.g., {"enabled": false, "hours": {"mon": {"start": "09:00", "end": "18:00"}}}
  
  // Out of office message
  outOfOfficeMessage  String?
  
  // Stats
  totalProcessed      Int      @default(0)
  totalAutoReplied    Int      @default(0)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  instagramAccount    InstagramAccount @relation(fields: [instagramAccountId], references: [id], onDelete: Cascade)

  @@index([isEnabled])
}

// ==================== SEASONAL CONTENT IDEAS ====================
// Stores AI-generated seasonal content ideas for caching and tracking

model SeasonalIdea {
  id                String   @id @default(cuid())
  userId            String
  
  // Time context
  month             Int      // 1-12
  year              Int
  
  // Idea content
  title             String
  description       String
  contentType       String   // "image" | "video" | "carousel"
  
  // AI-generated prompts
  imagePrompt       String?
  videoPrompt       String?
  captionSuggestion String?
  hashtags          String   @default("[]") // JSON array as string for SQLite
  seasonalTags      String   @default("[]") // JSON array as string for SQLite
  
  // Suggested publish date
  suggestedDate     DateTime?
  
  // Usage tracking
  isUsed            Boolean  @default(false)
  usedAt            DateTime?
  projectId         String?  // Reference to created project if used
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, month, year])
  @@index([userId, isUsed])
}